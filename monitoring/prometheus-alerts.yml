groups:
- name: health_export_api_alerts
  rules:
  # High Error Rate Alerts
  - alert: HighHTTPErrorRate
    expr: rate(health_export_http_requests_total{status_code=~"5.."}[5m]) / rate(health_export_http_requests_total[5m]) > 0.1
    for: 2m
    labels:
      severity: critical
      service: health-export-api
      component: http
    annotations:
      summary: "High HTTP error rate detected"
      description: "HTTP error rate is {{ $value | humanizePercentage }} for the last 5 minutes, which is above the 10% threshold."

  - alert: HighIngestErrorRate
    expr: rate(health_export_errors_total{endpoint="/api/v1/ingest"}[5m]) > 10
    for: 3m
    labels:
      severity: warning
      service: health-export-api
      component: ingestion
    annotations:
      summary: "High ingestion error rate"
      description: "Ingestion endpoint is experiencing {{ $value }} errors per second over the last 5 minutes."

  # Performance Alerts
  - alert: HighResponseTime
    expr: histogram_quantile(0.95, rate(health_export_http_request_duration_seconds_bucket[5m])) > 1.0
    for: 5m
    labels:
      severity: warning
      service: health-export-api
      component: performance
    annotations:
      summary: "High HTTP response time"
      description: "95th percentile response time is {{ $value | humanizeDuration }} which exceeds 1 second threshold."

  - alert: SlowBatchProcessing
    expr: histogram_quantile(0.95, rate(health_export_batch_processing_duration_seconds_bucket[5m])) > 30
    for: 5m
    labels:
      severity: warning
      service: health-export-api
      component: batch-processing
    annotations:
      summary: "Slow batch processing detected"
      description: "95th percentile batch processing time is {{ $value | humanizeDuration }}, exceeding 30 second threshold."

  # Database Connection Pool Alerts  
  - alert: HighDatabaseConnectionUsage
    expr: (health_export_db_connections_active / (health_export_db_connections_active + health_export_db_connections_idle)) > 0.8
    for: 3m
    labels:
      severity: warning
      service: health-export-api
      component: database
    annotations:
      summary: "High database connection pool utilization"
      description: "Database connection pool utilization is {{ $value | humanizePercentage }}, exceeding 80% threshold."

  - alert: DatabaseConnectionPoolExhausted
    expr: health_export_db_connections_idle == 0
    for: 1m
    labels:
      severity: critical
      service: health-export-api
      component: database
    annotations:
      summary: "Database connection pool exhausted"
      description: "No idle database connections available. All connections are in use."

  - alert: HighDatabaseConnectionWaitTime
    expr: histogram_quantile(0.95, rate(health_export_db_connection_wait_time_seconds_bucket[5m])) > 1.0
    for: 3m
    labels:
      severity: warning
      service: health-export-api
      component: database
    annotations:
      summary: "High database connection wait time"
      description: "95th percentile database connection wait time is {{ $value | humanizeDuration }}, exceeding 1 second."

  # Service Health Alerts
  - alert: ServiceDown
    expr: up{job="health-export-api"} == 0
    for: 1m
    labels:
      severity: critical
      service: health-export-api
      component: service
    annotations:
      summary: "Health Export API service is down"
      description: "Health Export API service has been down for more than 1 minute."

  - alert: NoIngestActivity
    expr: rate(health_export_ingest_requests_total[30m]) == 0
    for: 30m
    labels:
      severity: warning
      service: health-export-api
      component: ingestion
    annotations:
      summary: "No ingestion activity detected"
      description: "No health data ingestion requests received in the last 30 minutes."

  # Business Logic Alerts
  - alert: HighValidationFailureRate
    expr: rate(health_export_ingest_metrics_processed_total{status="failed"}[5m]) / rate(health_export_ingest_metrics_processed_total[5m]) > 0.2
    for: 5m
    labels:
      severity: warning
      service: health-export-api
      component: validation
    annotations:
      summary: "High validation failure rate"
      description: "{{ $value | humanizePercentage }} of health metrics are failing validation, exceeding 20% threshold."

  - alert: LowActiveUserCount
    expr: health_export_active_users_24h < 10
    for: 10m
    labels:
      severity: info
      service: health-export-api
      component: business
    annotations:
      summary: "Low active user count"
      description: "Only {{ $value }} active users in the last 24 hours, which may indicate service issues."

  # Rate Limiting Alerts
  - alert: HighRateLimitingActivity
    expr: rate(health_export_rate_limited_requests_total[5m]) > 5
    for: 3m
    labels:
      severity: warning
      service: health-export-api
      component: rate-limiting
    annotations:
      summary: "High rate limiting activity"
      description: "Rate limiting is blocking {{ $value }} requests per second, indicating potential abuse or misconfigured clients."

  # Authentication Alerts
  - alert: HighAuthenticationFailureRate
    expr: rate(health_export_auth_attempts_total{result="failure"}[5m]) / rate(health_export_auth_attempts_total[5m]) > 0.1
    for: 5m
    labels:
      severity: warning
      service: health-export-api
      component: authentication
    annotations:
      summary: "High authentication failure rate"
      description: "{{ $value | humanizePercentage }} of authentication attempts are failing, which may indicate brute force attacks."

  # Data Volume Alerts
  - alert: UnusuallyHighDataVolume
    expr: rate(health_export_data_volume_bytes_total[5m]) > 100000000  # 100MB/s
    for: 5m
    labels:
      severity: warning
      service: health-export-api
      component: data-volume
    annotations:
      summary: "Unusually high data volume"
      description: "Data ingestion rate is {{ $value | humanizeBytes }}/second, which is unusually high and may indicate data quality issues."

  - alert: NoDataIngestion
    expr: rate(health_export_data_volume_bytes_total{operation="received"}[30m]) == 0
    for: 30m
    labels:
      severity: warning
      service: health-export-api
      component: data-ingestion
    annotations:
      summary: "No data ingestion detected"
      description: "No data has been ingested for the last 30 minutes."

- name: health_export_api_capacity_alerts
  rules:
  # Capacity Planning Alerts
  - alert: HighThroughputNearingCapacity
    expr: rate(health_export_http_requests_total[5m]) > 80  # 80 RPS threshold
    for: 10m
    labels:
      severity: info
      service: health-export-api
      component: capacity
    annotations:
      summary: "High throughput - approaching capacity limits"
      description: "Current request rate is {{ $value }} RPS, approaching the designed capacity limit."

  - alert: LargeMetricsBatchesFrequent
    expr: rate(health_export_batch_processing_duration_seconds_bucket{batch_size_bucket="xlarge",le="+Inf"}[5m]) > 1
    for: 10m
    labels:
      severity: info
      service: health-export-api
      component: capacity
    annotations:
      summary: "Frequent large metric batches detected"
      description: "Large metric batches (>1000 metrics) are being processed at {{ $value }} batches per second, indicating potential capacity concerns."

# AUDIT-007: Enhanced Monitoring and Alerting Rules
- name: health_export_api_audit_007_alerts
  rules:
  # Validation Error Rate Monitoring (>10% threshold)
  - alert: HighValidationErrorRate
    expr: histogram_quantile(0.50, rate(health_export_validation_error_rate_bucket[5m])) > 0.10
    for: 2m
    labels:
      severity: warning
      service: health-export-api
      component: validation
      audit_story: AUDIT-007
    annotations:
      summary: "Validation error rate exceeds 10% threshold"
      description: "Validation error rate is {{ $value | humanizePercentage }} (median over 5min), exceeding the 10% alert threshold. Review data quality and validation rules."

  # Critical Validation Error Rate (>25% threshold)
  - alert: CriticalValidationErrorRate
    expr: histogram_quantile(0.50, rate(health_export_validation_error_rate_bucket[5m])) > 0.25
    for: 1m
    labels:
      severity: critical
      service: health-export-api
      component: validation
      audit_story: AUDIT-007
    annotations:
      summary: "Critical validation error rate detected"
      description: "Validation error rate is {{ $value | humanizePercentage }} (median over 5min), exceeding critical 25% threshold. Immediate attention required."

  # Parameter Usage Approaching PostgreSQL Limit
  - alert: HighParameterUsage
    expr: histogram_quantile(0.95, rate(health_export_batch_parameter_usage_bucket[5m])) > 52428  # 80% of 65,535
    for: 3m
    labels:
      severity: warning
      service: health-export-api
      component: batch-processing
      audit_story: AUDIT-007
    annotations:
      summary: "Batch parameter usage approaching PostgreSQL limit"
      description: "95th percentile parameter usage is {{ $value }}, approaching PostgreSQL limit of 65,535. Consider reducing batch sizes."

  # Critical Parameter Usage Near Limit
  - alert: CriticalParameterUsage
    expr: histogram_quantile(0.95, rate(health_export_batch_parameter_usage_bucket[5m])) > 58981  # 90% of 65,535
    for: 1m
    labels:
      severity: critical
      service: health-export-api
      component: batch-processing
      audit_story: AUDIT-007
    annotations:
      summary: "Critical: Batch parameter usage near PostgreSQL limit"
      description: "95th percentile parameter usage is {{ $value }}, dangerously close to PostgreSQL limit of 65,535. Reduce batch sizes immediately."

  # Rate Limit Exhaustion Events
  - alert: FrequentRateLimitExhaustion
    expr: rate(health_export_rate_limit_exhaustion_total{threshold_percentage="80_percent"}[5m]) > 0.5
    for: 2m
    labels:
      severity: warning
      service: health-export-api
      component: rate-limiting
      audit_story: AUDIT-007
    annotations:
      summary: "Frequent rate limit near-exhaustion events"
      description: "Rate limit 80% threshold breaches occurring at {{ $value }} events per second. Consider adjusting limits or investigating client behavior."

  - alert: RateLimitFullExhaustion
    expr: rate(health_export_rate_limit_exhaustion_total{threshold_percentage="100_percent"}[5m]) > 0.1
    for: 1m
    labels:
      severity: critical
      service: health-export-api
      component: rate-limiting
      audit_story: AUDIT-007
    annotations:
      summary: "Rate limits being fully exhausted"
      description: "Rate limit full exhaustion (100%) events occurring at {{ $value }} per second. Clients are being blocked - investigate immediately."

  # Rate Limit Usage Ratio Monitoring
  - alert: HighRateLimitUsageRatio
    expr: health_export_rate_limit_usage_ratio > 0.90
    for: 5m
    labels:
      severity: warning
      service: health-export-api
      component: rate-limiting
      audit_story: AUDIT-007
    annotations:
      summary: "Rate limit usage ratio very high"
      description: "Rate limit usage ratio is {{ $value | humanizePercentage }} for {{ $labels.key_identifier }}, indicating near-exhaustion. Monitor for potential issues."

  # Validation Error Categories Monitoring
  - alert: HighRangeViolationErrors
    expr: rate(health_export_validation_errors_total{error_category="range_violation"}[5m]) > 5
    for: 3m
    labels:
      severity: warning
      service: health-export-api
      component: validation
      audit_story: AUDIT-007
    annotations:
      summary: "High rate of range violation errors"
      description: "Range violation validation errors occurring at {{ $value }} errors per second. Review client data quality or validation thresholds."

  - alert: HighRequiredFieldMissingErrors
    expr: rate(health_export_validation_errors_total{error_category="required_field_missing"}[5m]) > 2
    for: 3m
    labels:
      severity: warning
      service: health-export-api
      component: validation
      audit_story: AUDIT-007
    annotations:
      summary: "High rate of required field missing errors"
      description: "Required field missing validation errors occurring at {{ $value }} errors per second. Check client integration implementation."

  # Batch Processing Parameter Usage by Type
  - alert: HeartRateParameterUsageHigh
    expr: histogram_quantile(0.90, rate(health_export_batch_parameter_usage_bucket{metric_type="heart_rate"}[5m])) > 45000  # ~70% of safe limit for heart rate
    for: 5m
    labels:
      severity: info
      service: health-export-api
      component: batch-processing
      audit_story: AUDIT-007
    annotations:
      summary: "Heart rate batch parameter usage high"
      description: "90th percentile heart rate batch parameter usage is {{ $value }}, approaching recommended limits. Monitor for efficiency."